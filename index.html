<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NCST Announcements</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container { 
      width: 100%;
      max-width: 800px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .posts-container {
      max-height: 70vh;
      overflow-y: auto;
      padding: 20px;
      scrollbar-width: thin;
      scrollbar-color: #3498db #f1f3f4;
    }

    .posts-container::-webkit-scrollbar {
      width: 8px;
    }

    .posts-container::-webkit-scrollbar-track {
      background: #f1f3f4;
      border-radius: 4px;
    }

    .posts-container::-webkit-scrollbar-thumb {
      background: #3498db;
      border-radius: 4px;
    }

    .posts-container::-webkit-scrollbar-thumb:hover {
      background: #2980b9;
    }

    .post { 
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-left: 4px solid #3498db;
    }

    .post:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .post:last-child { 
      margin-bottom: 0;
    }

    .post-title {
      font-size: 1.4em;
      color: #2c3e50;
      margin-bottom: 15px;
      font-weight: 600;
      line-height: 1.3;
    }

    .post-image {
      margin: 15px 0;
      text-align: center;
    }

    .post-image img { 
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      cursor: zoom-in;
      transition: transform 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .post-image img:hover {
      transform: scale(1.02);
    }

    .post-text { 
      color: #555;
      line-height: 1.6;
      margin-bottom: 15px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .post-text.collapsed {
      max-height: 80px;
      position: relative;
    }

    .post-text.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30px;
      background: linear-gradient(transparent, white);
    }

    .toggle-btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
    }

    .toggle-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }

    .post-link {
      display: inline-block;
      margin-top: 10px;
      color: #3498db;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 16px;
      border: 2px solid #3498db;
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    .post-link:hover {
      background: #3498db;
      color: white;
      transform: translateY(-1px);
    }

    .error { 
      color: #e74c3c;
      text-align: center;
      padding: 40px;
      font-size: 1.1em;
    }

    .loading { 
      text-align: center;
      color: #7f8c8d;
      padding: 40px;
      font-size: 1.1em;
    }

    /* Modal styles for image zoom */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90%;
      max-height: 90%;
    }

    .modal img {
      width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .close {
      position: absolute;
      top: 20px;
      right: 35px;
      color: #fff;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .close:hover {
      color: #3498db;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        margin: 0;
      }

      .header h1 {
        font-size: 2em;
      }

      .posts-container {
        max-height: 60vh;
        padding: 15px;
      }

      .post {
        padding: 20px;
      }

      .post-title {
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📢 NCST Announcements</h1>
      <p>Stay updated with the latest news and announcements</p>
    </div>
    <div class="posts-container">
      <div id="posts" class="loading">Loading announcements...</div>
    </div>
  </div>

  <!-- Modal for image zoom -->
  <div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <div class="modal-content">
      <img id="modalImage" src="" alt="">
    </div>
  </div>

  <script>
    class AnnouncementManager {
  constructor() {
    this.API_URL = "https://announcement-vayk.onrender.com/api/announcements";
    this.UPDATE_INTERVAL = 5 * 60 * 1000; // 5 minutes
    this.posts = [];
    this.lastUpdated = null;
    this.updateTimer = null;
    this.isLoading = false;
    this.retryCount = 0;
    this.maxRetries = 3;
    
    // Initialize
    this.init();
  }

  init() {
    this.createUpdateStatus();
    this.loadPosts();
    this.startAutoUpdate();
    this.setupVisibilityChange();
    this.setupImageZoom();
  }

  createUpdateStatus() {
    // Create status indicator
    const header = document.querySelector('.header');
    const statusDiv = document.createElement('div');
    statusDiv.id = 'update-status';
    statusDiv.innerHTML = `
      <div class="status-bar">
        <span id="last-updated">Never updated</span>
        <span id="next-update">Next update in: --</span>
        <button id="refresh-btn" class="refresh-btn">🔄 Refresh Now</button>
      </div>
      <div id="update-indicator" class="update-indicator hidden">
        <div class="pulse"></div>
        <span>Checking for updates...</span>
      </div>
    `;
    
    header.appendChild(statusDiv);

    // Add refresh button functionality
    document.getElementById('refresh-btn').addEventListener('click', () => {
      this.loadPosts(true);
    });

    // Add styles for status bar
    this.addStatusStyles();
  }

  addStatusStyles() {
    const style = document.createElement('style');
    style.textContent = `
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        font-size: 0.85em;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .refresh-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 5px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.8em;
        transition: all 0.3s ease;
      }
      
      .refresh-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }
      
      .refresh-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .update-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 8px;
        background: rgba(52, 152, 219, 0.2);
        border-radius: 8px;
        margin-top: 10px;
        font-size: 0.85em;
        transition: all 0.3s ease;
      }
      
      .update-indicator.hidden {
        display: none;
      }
      
      .pulse {
        width: 12px;
        height: 12px;
        background: #3498db;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
      }
      
      @keyframes pulse {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
        100% { opacity: 1; transform: scale(1); }
      }
      
      .new-post {
        border-left: 4px solid #e74c3c !important;
        animation: slideIn 0.5s ease-out;
      }
      
      .new-post::before {
        content: "🆕 NEW";
        position: absolute;
        top: -5px;
        right: 15px;
        background: #e74c3c;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7em;
        font-weight: bold;
      }
      
      .post {
        position: relative;
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #2ecc71;
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 1001;
        animation: slideInRight 0.3s ease-out;
      }
      
      .notification.error {
        background: #e74c3c;
      }
      
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @media (max-width: 768px) {
        .status-bar {
          flex-direction: column;
          text-align: center;
        }
        
        .notification {
          right: 10px;
          left: 10px;
          top: 10px;
        }
      }
    `;
    document.head.appendChild(style);
  }

  async loadPosts(isManualRefresh = false) {
    if (this.isLoading) return;
    
    this.isLoading = true;
    const refreshBtn = document.getElementById('refresh-btn');
    const updateIndicator = document.getElementById('update-indicator');
    
    if (refreshBtn) {
      refreshBtn.disabled = true;
      refreshBtn.textContent = '⏳ Updating...';
    }
    
    if (!isManualRefresh) {
      updateIndicator?.classList.remove('hidden');
    }

    try {
      const res = await fetch(`${this.API_URL}?t=${Date.now()}`); // Cache busting
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Response is not JSON');
      }
      
      const newPosts = await res.json();
      
      if (!newPosts || newPosts.length === 0) {
        this.displayError('📭 No announcements found.');
        return;
      }

      // Sort posts by date if available, or keep original order
      const sortedPosts = this.sortPostsByDate(newPosts);
      
      // Check for new posts
      const hasNewPosts = this.checkForNewPosts(sortedPosts);
      
      this.posts = sortedPosts;
      this.renderPosts(hasNewPosts);
      this.lastUpdated = new Date();
      this.retryCount = 0; // Reset retry count on success
      
      this.updateStatus();
      
      if (hasNewPosts && this.lastUpdated) {
        this.showNotification(`🎉 ${hasNewPosts} new announcement(s) found!`);
      } else if (isManualRefresh) {
        this.showNotification('✅ Announcements updated successfully!');
      }
      
    } catch (err) {
      console.error("Error loading posts:", err);
      this.handleError(err, isManualRefresh);
    } finally {
      this.isLoading = false;
      
      if (refreshBtn) {
        refreshBtn.disabled = false;
        refreshBtn.textContent = '🔄 Refresh Now';
      }
      
      updateIndicator?.classList.add('hidden');
    }
  }

  sortPostsByDate(posts) {
    // Try to extract date from title or content
    return posts.sort((a, b) => {
      const dateA = this.extractDate(a.title + ' ' + a.text);
      const dateB = this.extractDate(b.title + ' ' + b.text);
      
      if (dateA && dateB) {
        return dateB - dateA; // Newest first
      }
      
      // If no dates found, maintain original order
      return 0;
    });
  }

  extractDate(text) {
    // Try to find dates in various formats
    const datePatterns = [
      /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})/,
      /(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/,
      /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]* \d{1,2},? \d{4}/i,
      /\d{1,2} (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]* \d{4}/i
    ];
    
    for (const pattern of datePatterns) {
      const match = text.match(pattern);
      if (match) {
        const date = new Date(match[0]);
        if (!isNaN(date.getTime())) {
          return date;
        }
      }
    }
    
    return null;
  }

  checkForNewPosts(newPosts) {
    if (!this.posts || this.posts.length === 0) return 0;
    
    const oldTitles = new Set(this.posts.map(post => post.title));
    const newCount = newPosts.filter(post => !oldTitles.has(post.title)).length;
    
    return newCount;
  }

  renderPosts(newPostsCount = 0) {
    const container = document.getElementById("posts");
    container.innerHTML = "";

    this.posts.forEach((post, index) => {
      const div = document.createElement("div");
      div.className = "post";
      
      // Mark new posts
      if (newPostsCount > 0 && index < newPostsCount) {
        div.classList.add('new-post');
      }
      
      const postId = `post-${index}`;
      
      div.innerHTML = `
        <div class="post-title">${post.title || 'No Title Available'}</div>
        ${post.image ? `
          <div class="post-image">
            <img src="${post.image}" alt="Announcement image" class="zoomable-image" data-src="${post.image}">
          </div>
        ` : ""}
        <div class="post-text collapsed" id="text-${postId}">
          ${post.text || 'No description available.'}
        </div>
        <button class="toggle-btn" id="toggle-${postId}">Read More</button>
        ${post.link ? `<a href="${post.link}" target="_blank" class="post-link">🔗 View Original</a>` : ""}
      `;

      // Add toggle functionality
      const textElement = div.querySelector(`#text-${postId}`);
      const toggleBtn = div.querySelector(`#toggle-${postId}`);
      
      toggleBtn.addEventListener("click", () => {
        if (textElement.classList.contains('collapsed')) {
          textElement.classList.remove('collapsed');
          textElement.style.maxHeight = 'none';
          toggleBtn.textContent = 'Read Less';
        } else {
          textElement.classList.add('collapsed');
          textElement.style.maxHeight = '80px';
          toggleBtn.textContent = 'Read More';
        }
      });

      container.appendChild(div);
    });

    // Re-setup image zoom for new content
    this.setupImageZoom();
  }

  handleError(err, isManualRefresh) {
    this.retryCount++;
    
    if (this.retryCount <= this.maxRetries) {
      // Retry with exponential backoff
      const retryDelay = Math.min(1000 * Math.pow(2, this.retryCount - 1), 10000);
      setTimeout(() => this.loadPosts(), retryDelay);
      return;
    }

    const container = document.getElementById("posts");
    
    if (this.posts.length > 0) {
      // Show error but keep existing posts
      this.showNotification(`⚠️ Update failed: ${err.message}`, 'error');
    } else {
      // Show full error if no posts loaded
      this.displayError(`
        ⚠️ Could not load announcements.<br>
        <small>Error: ${err.message}</small><br>
        <button onclick="announcementManager.loadPosts(true)" class="toggle-btn" style="margin-top: 15px;">🔄 Retry</button>
      `);
    }
  }

  displayError(message) {
    document.getElementById("posts").innerHTML = `<div class="error">${message}</div>`;
  }

  updateStatus() {
    const lastUpdatedEl = document.getElementById('last-updated');
    const nextUpdateEl = document.getElementById('next-update');
    
    if (this.lastUpdated) {
      lastUpdatedEl.textContent = `Last updated: ${this.lastUpdated.toLocaleTimeString()}`;
    }
    
    this.updateCountdown();
  }

  updateCountdown() {
    if (!this.lastUpdated) return;
    
    const nextUpdateEl = document.getElementById('next-update');
    const nextUpdate = new Date(this.lastUpdated.getTime() + this.UPDATE_INTERVAL);
    
    const updateTimer = setInterval(() => {
      const now = new Date();
      const timeLeft = nextUpdate - now;
      
      if (timeLeft <= 0) {
        clearInterval(updateTimer);
        nextUpdateEl.textContent = 'Updating now...';
        return;
      }
      
      const minutes = Math.floor(timeLeft / 60000);
      const seconds = Math.floor((timeLeft % 60000) / 1000);
      nextUpdateEl.textContent = `Next update in: ${minutes}m ${seconds}s`;
    }, 1000);
  }

  startAutoUpdate() {
    this.updateTimer = setInterval(() => {
      this.loadPosts();
    }, this.UPDATE_INTERVAL);
  }

  stopAutoUpdate() {
    if (this.updateTimer) {
      clearInterval(this.updateTimer);
      this.updateTimer = null;
    }
  }

  setupVisibilityChange() {
    // Pause updates when page is not visible
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        this.stopAutoUpdate();
      } else {
        // Resume and immediately check for updates
        this.startAutoUpdate();
        this.loadPosts();
      }
    });
  }

  showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 4000);
  }

  setupImageZoom() {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const closeBtn = document.getElementsByClassName('close')[0];
    
    if (!modal || !modalImg || !closeBtn) return;
    
    // Remove existing listeners to prevent duplicates
    document.querySelectorAll('.zoomable-image').forEach(img => {
      img.replaceWith(img.cloneNode(true));
    });
    
    // Add click listeners to all zoomable images
    document.querySelectorAll('.zoomable-image').forEach(img => {
      img.addEventListener('click', function() {
        modal.style.display = 'block';
        modalImg.src = this.src;
      });
    });

    // Close modal when clicking the X
    closeBtn.addEventListener('click', function() {
      modal.style.display = 'none';
    });

    // Close modal when clicking outside the image
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.style.display === 'block') {
        modal.style.display = 'none';
      }
    });
  }

  // Public method to change update interval
  setUpdateInterval(minutes) {
    this.UPDATE_INTERVAL = minutes * 60 * 1000;
    this.stopAutoUpdate();
    this.startAutoUpdate();
    this.showNotification(`Update interval set to ${minutes} minutes`);
  }

  // Public method to get current status
  getStatus() {
    return {
      isLoading: this.isLoading,
      lastUpdated: this.lastUpdated,
      postsCount: this.posts.length,
      updateInterval: this.UPDATE_INTERVAL / 60000,
      retryCount: this.retryCount
    };
  }
}

// Initialize the announcement manager
let announcementManager;

document.addEventListener('DOMContentLoaded', function() {
  announcementManager = new AnnouncementManager();
});

// Make manager available globally for debugging
window.announcementManager = announcementManager;
  </script>
  
</body>
</html>
